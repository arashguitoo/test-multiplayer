<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Wer √ºberlebt? - Live Battle</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        
        h1 {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        
        /* Login Screen */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 85vh;
            gap: 20px;
        }
        
        .logo { font-size: 4em; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        #login-screen h2 { font-size: 1.3em; color: #ffd700; text-align: center; }
        
        #login-screen input {
            font-size: 1.2em;
            padding: 15px 25px;
            border: 2px solid #ffd700;
            border-radius: 30px;
            width: 280px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        #login-screen input::placeholder { color: rgba(255,255,255,0.5); }
        
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        
        #login-screen button {
            font-size: 1.1em;
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #login-screen button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 30px rgba(255,215,0,0.5);
        }
        
        #login-screen button.secondary {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
        }
        
        /* Lobby */
        #lobby-screen { display: none; text-align: center; }
        
        .lobby-box {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .lobby-box h2 { color: #ffd700; margin-bottom: 20px; }
        
        .waiting-players {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .waiting-player {
            padding: 10px 20px;
            background: rgba(255,215,0,0.2);
            border-radius: 25px;
            border: 1px solid rgba(255,215,0,0.5);
        }
        
        .start-game-btn {
            font-size: 1.3em;
            padding: 15px 50px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .start-game-btn:hover { transform: scale(1.05); }
        .start-game-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Game Screen */
        #game-screen { display: none; }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }
        
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-name { font-weight: bold; color: #ffd700; font-size: 0.95em; }
        .lives { font-size: 1.3em; letter-spacing: 2px; }
        
        .timer-box {
            text-align: center;
        }
        
        .timer {
            font-size: 2.5em;
            font-weight: bold;
            color: #00cec9;
            text-shadow: 0 0 20px rgba(0,206,201,0.5);
        }
        
        .timer.warning { color: #fdcb6e; }
        .timer.danger { color: #e74c3c; animation: timerPulse 0.5s infinite; }
        
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .progress-info { text-align: right; }
        .question-num { font-size: 1em; color: #ffd700; }
        .survivors { font-size: 0.85em; color: #00cec9; }
        
        /* Quiz Section */
        .quiz-section {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .category-badge {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255,215,0,0.2);
            border-radius: 20px;
            font-size: 0.85em;
            color: #ffd700;
            margin-bottom: 12px;
        }
        
        .question { font-size: 1.3em; margin-bottom: 20px; line-height: 1.4; }
        
        .answers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        @media (max-width: 600px) { .answers { grid-template-columns: 1fr; } }
        
        .answer-btn {
            padding: 15px 18px;
            font-size: 1em;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .answer-btn:hover:not(:disabled):not(.selected) {
            background: rgba(255,215,0,0.2);
            border-color: #ffd700;
        }
        
        .answer-btn.selected {
            background: rgba(100,100,255,0.3);
            border-color: #6c5ce7;
        }
        
        .answer-btn.correct {
            background: rgba(0,184,148,0.5);
            border-color: #00b894;
        }
        
        .answer-btn.wrong {
            background: rgba(214,48,49,0.5);
            border-color: #d63031;
        }
        
        .answer-btn:disabled { cursor: not-allowed; }
        
        .answer-btn .letter {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .answer-status {
            text-align: center;
            padding: 15px;
            margin-top: 15px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }
        
        .answer-status.waiting {
            display: block;
            background: rgba(108,92,231,0.3);
            color: #a29bfe;
        }
        
        .answer-status.correct {
            display: block;
            background: rgba(0,184,148,0.3);
            color: #00b894;
        }
        
        .answer-status.wrong {
            display: block;
            background: rgba(214,48,49,0.3);
            color: #ff7675;
        }
        
        .answer-status.timeout {
            display: block;
            background: rgba(253,203,110,0.3);
            color: #fdcb6e;
        }
        
        /* Live Players */
        .live-players {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 12px;
        }
        
        .live-players h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .players-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .player-chip {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        .player-chip.dead { opacity: 0.4; text-decoration: line-through; }
        .player-chip.is-me { border: 2px solid #ffd700; background: rgba(255,215,0,0.2); }
        .player-chip.answered { border-color: #6c5ce7; }
        
        /* Game Over */
        #gameover-screen { display: none; text-align: center; padding: 30px 20px; }
        #gameover-screen .result-icon { font-size: 4em; margin-bottom: 15px; }
        #gameover-screen h2 { font-size: 1.8em; margin-bottom: 10px; }
        #gameover-screen .result-message { font-size: 1.1em; color: #aaa; margin-bottom: 25px; }
        
        .final-stats {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: left;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-row:last-child { border-bottom: none; }
        
        .winners-list {
            background: rgba(255,215,0,0.1);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 25px;
        }
        
        .winners-list h3 { color: #ffd700; margin-bottom: 12px; }
        
        .winner-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 6px;
        }
        
        .play-again-btn {
            font-size: 1.1em;
            padding: 12px 35px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
        }
        
        .play-again-btn:hover { transform: scale(1.05); }
        
        /* Eliminated Overlay */
        #eliminated-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
            gap: 15px;
        }
        
        #eliminated-overlay .skull { font-size: 5em; }
        #eliminated-overlay h2 { font-size: 1.8em; color: #d63031; }
        #eliminated-overlay p { color: #aaa; }
        
        .watch-btn {
            padding: 12px 25px;
            border: 2px solid #ffd700;
            background: transparent;
            color: #ffd700;
            border-radius: 20px;
            cursor: pointer;
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            background: rgba(0,0,0,0.5);
        }
        
        .connection-status.connected { color: #00b894; }
        .connection-status.disconnected { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">Verbinde...</div>
    
    <div class="container">
        <h1>üéØ Wer √ºberlebt? - Live Battle</h1>
        
        <!-- Login Screen -->
        <div id="login-screen">
            <div class="logo">üéØ</div>
            <h2>50 Fragen ‚Ä¢ 3 Leben ‚Ä¢ 15 Sekunden<br>Wer √ºberlebt?</h2>
            <input type="text" id="player-name-input" placeholder="Dein Name" maxlength="15">
            <div class="btn-group">
                <button id="create-game-btn">üéÆ Neues Spiel</button>
                <button id="join-game-btn" class="secondary">üö™ Beitreten</button>
            </div>
            <p style="color: #888; font-size: 0.85em; margin-top: 15px;">
                Reflexivverben ‚Ä¢ Verben mit Pr√§positionen<br>
                Modalverben Pr√§teritum ‚Ä¢ Akkusativ/Dativ
            </p>
        </div>
        
        <!-- Lobby Screen -->
        <div id="lobby-screen">
            <div class="lobby-box">
                <h2>‚è≥ Warteraum</h2>
                <p style="color: #aaa; margin-bottom: 15px;">Spieler warten auf Start...</p>
                <div class="waiting-players" id="waiting-players"></div>
                <button class="start-game-btn" id="start-game-btn">‚ñ∂Ô∏è Spiel starten</button>
                <p style="color: #888; font-size: 0.85em; margin-top: 15px;" id="host-info"></p>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen">
            <div class="game-header">
                <div class="player-info">
                    <span class="player-name" id="display-name"></span>
                    <span class="lives" id="display-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
                </div>
                <div class="timer-box">
                    <div class="timer" id="timer">15</div>
                </div>
                <div class="progress-info">
                    <div class="question-num" id="question-num">Frage 1/50</div>
                    <div class="survivors" id="survivors">üë• 0 dabei</div>
                </div>
            </div>
            
            <div class="quiz-section">
                <div class="category-badge" id="category"></div>
                <div class="question" id="question"></div>
                <div class="answers" id="answers"></div>
                <div class="answer-status" id="answer-status"></div>
            </div>
            
            <div class="live-players">
                <h3><span class="live-dot"></span> Spieler</h3>
                <div class="players-grid" id="players-grid"></div>
            </div>
        </div>
        
        <!-- Game Over Screen -->
        <div id="gameover-screen">
            <div class="result-icon" id="result-icon">üèÜ</div>
            <h2 id="result-title">Spiel beendet!</h2>
            <p class="result-message" id="result-message"></p>
            
            <div class="final-stats">
                <div class="stat-row">
                    <span>Richtige Antworten</span>
                    <span id="stat-correct">0</span>
                </div>
                <div class="stat-row">
                    <span>Falsche Antworten</span>
                    <span id="stat-wrong">0</span>
                </div>
                <div class="stat-row">
                    <span>Verbleibende Leben</span>
                    <span id="stat-lives">0</span>
                </div>
            </div>
            
            <div class="winners-list">
                <h3>üèÜ √úberlebende</h3>
                <div id="winners-content"></div>
            </div>
            
            <button class="play-again-btn" id="play-again-btn">üîÑ Neues Spiel</button>
        </div>
        
        <!-- Eliminated Overlay -->
        <div id="eliminated-overlay">
            <div class="skull">üíÄ</div>
            <h2>Ausgeschieden!</h2>
            <p>Du hast alle 3 Leben verloren.</p>
            <button class="watch-btn" id="watch-btn">üëÄ Weiter zuschauen</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        if (typeof firebase === 'undefined') {
            alert("Firebase konnte nicht geladen werden.");
            return;
        }
        
        const firebaseConfig = {
            apiKey: "AIzaSyBDChXlm34Kr7Gg0Dw458GiiwoLnWJAnxM",
            authDomain: "lern-deutsch-arash.firebaseapp.com",
            databaseURL: "https://lern-deutsch-arash-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lern-deutsch-arash",
            storageBucket: "lern-deutsch-arash.firebasestorage.app",
            messagingSenderId: "845503292114",
            appId: "1:845503292114:web:f76ab5fcde1e978d00c30b"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Alle 50 Fragen (feste Reihenfolge f√ºr Sync)
        const allQuestions = [
            // REFLEXIVVERBEN (12)
            { category: "Reflexivverben", q: "Ich ___ mich jeden Morgen.", answers: ["wasche", "waschst", "waschen", "w√§scht"], correct: 0 },
            { category: "Reflexivverben", q: "Er ___ sich auf die Pr√ºfung vor.", answers: ["bereitet", "bereite", "bereitest", "bereiten"], correct: 0 },
            { category: "Reflexivverben", q: "Wir ___ uns √ºber das Geschenk.", answers: ["freuen", "freut", "freue", "freust"], correct: 0 },
            { category: "Reflexivverben", q: "Du musst ___ beeilen!", answers: ["dich", "sich", "mich", "uns"], correct: 0 },
            { category: "Reflexivverben", q: "Sie (Sg.) interessiert ___ f√ºr Musik.", answers: ["sich", "mich", "dich", "uns"], correct: 0 },
            { category: "Reflexivverben", q: "Ich habe ___ erk√§ltet.", answers: ["mich", "sich", "dich", "mir"], correct: 0 },
            { category: "Reflexivverben", q: "K√∂nnt ihr ___ das vorstellen?", answers: ["euch", "sich", "uns", "mir"], correct: 0 },
            { category: "Reflexivverben", q: "Er hat ___ verletzt.", answers: ["sich", "mich", "ihn", "ihm"], correct: 0 },
            { category: "Reflexivverben", q: "Wir treffen ___ um 8 Uhr.", answers: ["uns", "euch", "sich", "mich"], correct: 0 },
            { category: "Reflexivverben", q: "Ich ziehe ___ schnell an.", answers: ["mich", "mir", "sich", "dich"], correct: 0 },
            { category: "Reflexivverben", q: "Sie (Pl.) haben ___ gestritten.", answers: ["sich", "uns", "euch", "ihnen"], correct: 0 },
            { category: "Reflexivverben", q: "Setzt ___ bitte hin!", answers: ["euch", "sich", "uns", "dich"], correct: 0 },
            
            // VERBEN MIT PR√ÑPOSITIONEN (13)
            { category: "Verben + Pr√§position", q: "Ich warte ___ den Bus.", answers: ["auf", "f√ºr", "an", "√ºber"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Er denkt oft ___ seine Familie.", answers: ["an", "auf", "√ºber", "f√ºr"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Sie freut sich ___ das Wochenende.", answers: ["auf", "√ºber", "f√ºr", "an"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Wir sprechen ___ das Problem.", answers: ["√ºber", "von", "auf", "f√ºr"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Ich interessiere mich ___ Sport.", answers: ["f√ºr", "an", "auf", "√ºber"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Er bittet mich ___ Hilfe.", answers: ["um", "f√ºr", "auf", "nach"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Sie √§rgert sich ___ den Fehler.", answers: ["√ºber", "auf", "f√ºr", "an"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Ich tr√§ume ___ einem Urlaub.", answers: ["von", "√ºber", "an", "auf"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Er k√ºmmert sich ___ die Kinder.", answers: ["um", "f√ºr", "auf", "√ºber"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Wir haben ___ dem Chef gesprochen.", answers: ["mit", "zu", "bei", "von"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Sie bedankt sich ___ das Geschenk.", answers: ["f√ºr", "√ºber", "auf", "um"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Ich habe Angst ___ Spinnen.", answers: ["vor", "von", "f√ºr", "√ºber"], correct: 0 },
            { category: "Verben + Pr√§position", q: "Er verl√§sst sich ___ seine Freunde.", answers: ["auf", "an", "f√ºr", "mit"], correct: 0 },
            
            // MODALVERBEN PR√ÑTERITUM (13)
            { category: "Modalverben Pr√§t.", q: "Ich ___ gestern nicht kommen.", answers: ["konnte", "k√∂nnte", "kann", "gekonnt"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Er ___ fr√ºher aufstehen.", answers: ["musste", "m√ºsste", "muss", "gemusst"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Sie ___ als Kind nicht schwimmen.", answers: ["durfte", "d√ºrfte", "darf", "gedurft"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Wir ___ lange warten.", answers: ["mussten", "m√ºssen", "m√ºssten", "gemusst"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Ich ___ das nicht verstehen.", answers: ["konnte", "kann", "k√∂nnte", "gekonnt"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Er ___ immer Fu√üball spielen.", answers: ["wollte", "will", "wollten", "gewollt"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Du ___ das nicht tun!", answers: ["solltest", "sollst", "sollte", "gesollt"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Sie (Pl.) ___ nicht rauchen.", answers: ["durften", "d√ºrfen", "d√ºrften", "gedurft"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Als Kind ___ ich kein Gem√ºse.", answers: ["mochte", "mag", "m√∂chte", "gemocht"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Wir ___ fr√ºher viel reisen.", answers: ["konnten", "k√∂nnen", "k√∂nnten", "gekonnt"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Er ___ den Brief schreiben.", answers: ["sollte", "soll", "sollten", "gesollt"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Sie ___ unbedingt den Film sehen.", answers: ["wollte", "will", "wollten", "gewollt"], correct: 0 },
            { category: "Modalverben Pr√§t.", q: "Ich ___ leider nicht helfen.", answers: ["konnte", "kann", "k√∂nnte", "gekonnt"], correct: 0 },
            
            // AKKUSATIV/DATIV (12)
            { category: "Akkusativ/Dativ", q: "Ich schenke ___ ein Buch.", answers: ["dir", "dich", "du", "deiner"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Er gibt ___ das Geld.", answers: ["mir", "mich", "ich", "meiner"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Sie zeigt ___ die Fotos.", answers: ["uns", "wir", "unser", "unsere"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Ich kaufe ___ Mutter Blumen.", answers: ["meiner", "meine", "meinem", "meinen"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Kannst du ___ das erkl√§ren?", answers: ["mir", "mich", "ich", "meiner"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Er bringt ___ einen Kaffee.", answers: ["ihr", "sie", "ihren", "ihre"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Ich schicke ___ eine Nachricht.", answers: ["ihm", "ihn", "er", "seiner"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Sie leiht ___ das Auto.", answers: ["ihm", "ihn", "er", "sein"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Gib ___ bitte den Stift!", answers: ["mir", "mich", "ich", "meinen"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Er hat ___ geholfen.", answers: ["mir", "mich", "ich", "meiner"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Ich bringe ___ den Kuchen.", answers: ["euch", "ihr", "euer", "eure"], correct: 0 },
            { category: "Akkusativ/Dativ", q: "Sie hat ___ das Buch empfohlen.", answers: ["uns", "wir", "unser", "unsere"], correct: 0 }
        ];
        
        // Konstanten
        const QUESTION_TIME = 15; // Sekunden pro Frage
        const TOTAL_QUESTIONS = 50;
        const GAME_ID = "livebattle"; // Fester Game-Raum
        
        // Spielstatus
        let playerName = "";
        let playerId = "";
        let lives = 3;
        let correctAnswers = 0;
        let wrongAnswers = 0;
        let isHost = false;
        let isWatching = false;
        let currentQuestionIndex = -1;
        let hasAnswered = false;
        let selectedAnswer = null;
        let timerInterval = null;
        let gameRef = null;
        let playersRef = null;
        
        // Verbindungsstatus
        database.ref(".info/connected").on("value", (snap) => {
            const status = document.getElementById("connection-status");
            if (snap.val() === true) {
                status.textContent = "üü¢ Online";
                status.className = "connection-status connected";
            } else {
                status.textContent = "üî¥ Offline";
                status.className = "connection-status disconnected";
            }
        });
        
        // Event Listeners
        document.getElementById("create-game-btn").addEventListener("click", () => joinGame(true));
        document.getElementById("join-game-btn").addEventListener("click", () => joinGame(false));
        document.getElementById("start-game-btn").addEventListener("click", startGameAsHost);
        document.getElementById("play-again-btn").addEventListener("click", resetToLobby);
        document.getElementById("watch-btn").addEventListener("click", () => {
            isWatching = true;
            document.getElementById("eliminated-overlay").style.display = "none";
        });
        document.getElementById("player-name-input").addEventListener("keypress", (e) => {
            if (e.key === "Enter") joinGame(false);
        });
        
        function joinGame(asHost) {
            playerName = document.getElementById("player-name-input").value.trim();
            if (!playerName) {
                alert("Bitte gib deinen Namen ein!");
                return;
            }
            
            playerId = "p_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5);
            isHost = asHost;
            
            gameRef = database.ref("games/" + GAME_ID);
            playersRef = database.ref("games/" + GAME_ID + "/players");
            
            // Spieler hinzuf√ºgen
            playersRef.child(playerId).set({
                name: playerName,
                lives: 3,
                answered: false,
                lastAnswer: null,
                isHost: isHost
            });
            
            // Bei Disconnect entfernen
            playersRef.child(playerId).onDisconnect().remove();
            
            // Wenn Host: Spiel zur√ºcksetzen
            if (isHost) {
                gameRef.update({
                    status: "lobby",
                    currentQuestion: -1,
                    questionStartTime: null
                });
            }
            
            // UI
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("lobby-screen").style.display = "block";
            
            // Listeners starten
            setupGameListeners();
        }
        
        function setupGameListeners() {
            // Spieler-Updates
            playersRef.on("value", (snapshot) => {
                const players = [];
                snapshot.forEach((child) => {
                    players.push({ id: child.key, ...child.val() });
                });
                
                updateLobbyPlayers(players);
                updateGamePlayers(players);
            });
            
            // Spiel-Status Updates
            gameRef.on("value", (snapshot) => {
                const game = snapshot.val();
                if (!game) return;
                
                if (game.status === "playing") {
                    document.getElementById("lobby-screen").style.display = "none";
                    document.getElementById("game-screen").style.display = "block";
                    
                    if (game.currentQuestion !== currentQuestionIndex) {
                        currentQuestionIndex = game.currentQuestion;
                        showSyncedQuestion(game);
                    }
                } else if (game.status === "finished") {
                    endGame();
                }
            });
        }
        
        function updateLobbyPlayers(players) {
            const container = document.getElementById("waiting-players");
            container.innerHTML = players.map(p => 
                `<div class="waiting-player">${p.name} ${p.isHost ? 'üëë' : ''}</div>`
            ).join("");
            
            const hostInfo = document.getElementById("host-info");
            const host = players.find(p => p.isHost);
            if (host && host.id !== playerId) {
                hostInfo.textContent = `${host.name} ist der Spielleiter`;
                document.getElementById("start-game-btn").style.display = "none";
            } else if (isHost) {
                hostInfo.textContent = "Du bist der Spielleiter";
                document.getElementById("start-game-btn").style.display = "block";
                document.getElementById("start-game-btn").disabled = players.length < 1;
            }
        }
        
        function updateGamePlayers(players) {
            const grid = document.getElementById("players-grid");
            const survivors = players.filter(p => p.lives > 0);
            
            document.getElementById("survivors").textContent = `üë• ${survivors.length} dabei`;
            
            players.sort((a, b) => b.lives - a.lives);
            
            grid.innerHTML = "";
            players.forEach((player) => {
                const chip = document.createElement("div");
                chip.className = "player-chip";
                if (player.lives === 0) chip.classList.add("dead");
                if (player.id === playerId) chip.classList.add("is-me");
                if (player.answered) chip.classList.add("answered");
                
                const livesDisplay = player.lives > 0 
                    ? "‚ù§Ô∏è".repeat(player.lives) 
                    : "üíÄ";
                
                chip.innerHTML = `<span>${player.name}</span><span>${livesDisplay}</span>`;
                grid.appendChild(chip);
            });
        }
        
        function startGameAsHost() {
            if (!isHost) return;
            
            gameRef.update({
                status: "playing",
                currentQuestion: 0,
                questionStartTime: Date.now()
            });
        }
        
        function showSyncedQuestion(game) {
            if (currentQuestionIndex >= TOTAL_QUESTIONS) {
                gameRef.update({ status: "finished" });
                return;
            }
            
            // Reset
            hasAnswered = false;
            selectedAnswer = null;
            
            // Reset answered status f√ºr diesen Spieler
            playersRef.child(playerId).update({ answered: false, lastAnswer: null });
            
            const q = allQuestions[currentQuestionIndex];
            
            document.getElementById("question-num").textContent = `Frage ${currentQuestionIndex + 1}/${TOTAL_QUESTIONS}`;
            document.getElementById("category").textContent = q.category;
            document.getElementById("question").textContent = q.q;
            document.getElementById("display-name").textContent = playerName;
            updateLivesDisplay();
            
            // Antworten (NICHT mischen - alle sehen dieselbe Reihenfolge)
            const answersDiv = document.getElementById("answers");
            answersDiv.innerHTML = "";
            
            const letters = ["A", "B", "C", "D"];
            q.answers.forEach((answer, idx) => {
                const btn = document.createElement("button");
                btn.className = "answer-btn";
                btn.innerHTML = `<span class="letter">${letters[idx]}</span>${answer}`;
                btn.dataset.index = idx;
                btn.addEventListener("click", () => selectAnswer(btn, idx, q.correct));
                if (isWatching || lives === 0) btn.disabled = true;
                answersDiv.appendChild(btn);
            });
            
            // Status zur√ºcksetzen
            const statusDiv = document.getElementById("answer-status");
            statusDiv.className = "answer-status";
            statusDiv.textContent = "";
            
            // Timer starten
            startTimer(game.questionStartTime);
        }
        
        function selectAnswer(btn, answerIndex, correctIndex) {
            if (hasAnswered || lives === 0) return;
            
            hasAnswered = true;
            selectedAnswer = answerIndex;
            
            // Visual feedback
            btn.classList.add("selected");
            document.querySelectorAll(".answer-btn").forEach(b => b.disabled = true);
            
            // In Firebase speichern
            playersRef.child(playerId).update({
                answered: true,
                lastAnswer: answerIndex
            });
            
            // Status anzeigen
            const statusDiv = document.getElementById("answer-status");
            statusDiv.className = "answer-status waiting";
            statusDiv.textContent = "‚è≥ Warte auf Timer...";
        }
        
        function startTimer(questionStartTime) {
            if (timerInterval) clearInterval(timerInterval);
            
            const timerEl = document.getElementById("timer");
            
            function updateTimer() {
                const elapsed = Math.floor((Date.now() - questionStartTime) / 1000);
                const remaining = Math.max(0, QUESTION_TIME - elapsed);
                
                timerEl.textContent = remaining;
                timerEl.className = "timer";
                
                if (remaining <= 3) {
                    timerEl.classList.add("danger");
                } else if (remaining <= 5) {
                    timerEl.classList.add("warning");
                }
                
                if (remaining === 0) {
                    clearInterval(timerInterval);
                    evaluateAnswer();
                }
            }
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 100);
        }
        
        function evaluateAnswer() {
            const q = allQuestions[currentQuestionIndex];
            const correctIndex = q.correct;
            
            // Alle Buttons zeigen
            document.querySelectorAll(".answer-btn").forEach((btn, idx) => {
                btn.disabled = true;
                if (idx === correctIndex) {
                    btn.classList.add("correct");
                }
            });
            
            const statusDiv = document.getElementById("answer-status");
            
            if (!hasAnswered) {
                // Nicht geantwortet = Timeout = Leben verlieren
                if (lives > 0) {
                    lives--;
                    wrongAnswers++;
                    playersRef.child(playerId).update({ lives: lives });
                }
                statusDiv.className = "answer-status timeout";
                statusDiv.textContent = "‚è∞ Zeit abgelaufen! -1 Leben";
            } else if (selectedAnswer === correctIndex) {
                correctAnswers++;
                statusDiv.className = "answer-status correct";
                statusDiv.textContent = "‚úÖ Richtig!";
            } else {
                if (lives > 0) {
                    lives--;
                    playersRef.child(playerId).update({ lives: lives });
                }
                wrongAnswers++;
                
                // Falsche Antwort markieren
                document.querySelectorAll(".answer-btn").forEach((btn, idx) => {
                    if (idx === selectedAnswer) {
                        btn.classList.add("wrong");
                    }
                });
                
                statusDiv.className = "answer-status wrong";
                statusDiv.textContent = `‚ùå Falsch! Noch ${lives} Leben`;
            }
            
            updateLivesDisplay();
            
            // Check ob ausgeschieden
            if (lives === 0 && !isWatching) {
                setTimeout(() => {
                    document.getElementById("eliminated-overlay").style.display = "flex";
                }, 1000);
            }
            
            // N√§chste Frage nach 3 Sekunden (nur Host triggered)
            if (isHost) {
                setTimeout(() => {
                    const nextQ = currentQuestionIndex + 1;
                    if (nextQ >= TOTAL_QUESTIONS) {
                        gameRef.update({ status: "finished" });
                    } else {
                        gameRef.update({
                            currentQuestion: nextQ,
                            questionStartTime: Date.now()
                        });
                    }
                }, 3000);
            }
        }
        
        function updateLivesDisplay() {
            const display = lives > 0 
                ? "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(3 - lives)
                : "üíÄ";
            document.getElementById("display-lives").textContent = display;
        }
        
        function endGame() {
            if (timerInterval) clearInterval(timerInterval);
            
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("eliminated-overlay").style.display = "none";
            document.getElementById("gameover-screen").style.display = "block";
            
            if (lives > 0) {
                document.getElementById("result-icon").textContent = "üèÜ";
                document.getElementById("result-title").textContent = "Du hast √ºberlebt!";
                document.getElementById("result-message").textContent = "Gl√ºckwunsch!";
            } else {
                document.getElementById("result-icon").textContent = "üíÄ";
                document.getElementById("result-title").textContent = "Ausgeschieden!";
                document.getElementById("result-message").textContent = "Vielleicht n√§chstes Mal!";
            }
            
            document.getElementById("stat-correct").textContent = correctAnswers;
            document.getElementById("stat-wrong").textContent = wrongAnswers;
            document.getElementById("stat-lives").textContent = lives > 0 ? "‚ù§Ô∏è".repeat(lives) : "üíÄ";
            
            // Gewinner laden
            playersRef.once("value", (snapshot) => {
                const winners = [];
                snapshot.forEach((child) => {
                    const p = child.val();
                    if (p.lives > 0) winners.push(p);
                });
                
                const winnersContent = document.getElementById("winners-content");
                winnersContent.innerHTML = winners.length === 0 
                    ? "<p>Niemand hat √ºberlebt! üíÄ</p>"
                    : winners.map(w => `<div class="winner-item"><span>${w.name}</span><span>${"‚ù§Ô∏è".repeat(w.lives)}</span></div>`).join("");
            });
        }
        
        function resetToLobby() {
            // Reset lokal
            lives = 3;
            correctAnswers = 0;
            wrongAnswers = 0;
            currentQuestionIndex = -1;
            hasAnswered = false;
            isWatching = false;
            
            // UI
            document.getElementById("gameover-screen").style.display = "none";
            document.getElementById("login-screen").style.display = "block";
        }
        
    });
    </script>
    
    <script data-goatcounter="https://aguitoo.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
