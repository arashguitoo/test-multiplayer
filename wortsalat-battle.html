<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÄ Wortsalat-Battle</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#e17055 0%,#fdcb6e 100%);min-height:100vh;color:#fff}
        .container{max-width:900px;margin:0 auto;padding:15px}
        h1{text-align:center;font-size:1.5em;margin-bottom:15px;color:#2d3436}
        .screen{display:none!important}.screen.active{display:block!important}#login-screen.active{display:flex!important}
        
        #login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:85vh;gap:15px}
        .logo{font-size:4em;margin-bottom:10px}
        #login-screen h2{font-size:1.2em;color:#2d3436;text-align:center}
        .difficulty-select{display:flex;gap:10px;margin:15px 0;flex-wrap:wrap;justify-content:center}
        .diff-btn{padding:15px 25px;border:3px solid rgba(0,0,0,0.2);border-radius:15px;background:rgba(255,255,255,0.3);color:#2d3436;font-size:1em;font-weight:700;cursor:pointer;transition:all 0.3s}
        .diff-btn:hover,.diff-btn.selected{transform:scale(1.05)}
        .diff-btn.einfach{border-color:#00b894}.diff-btn.einfach.selected{background:#00b894;color:#fff}
        .diff-btn.mittel{border-color:#e17055}.diff-btn.mittel.selected{background:#e17055;color:#fff}
        .diff-btn.schwer{border-color:#d63031}.diff-btn.schwer.selected{background:#d63031;color:#fff}
        .input-group{display:flex;flex-direction:column;gap:10px;width:100%;max-width:300px}
        .input-group input,.input-group select{font-size:1.1em;padding:12px 20px;border:2px solid #2d3436;border-radius:25px;text-align:center;background:rgba(255,255,255,0.9);color:#2d3436}
        .input-group input::placeholder{color:#636e72}
        .input-group input.code-input{font-size:1.4em;letter-spacing:8px;text-transform:uppercase}
        .btn-primary{font-size:1.1em;padding:15px 40px;border:none;border-radius:30px;background:#2d3436;color:#fff;font-weight:700;cursor:pointer;width:100%;max-width:300px}
        .btn-secondary{font-size:1em;padding:12px 30px;border:2px solid #2d3436;border-radius:25px;background:transparent;color:#2d3436;cursor:pointer;width:100%;max-width:300px}
        .divider{display:flex;align-items:center;gap:15px;width:100%;max-width:300px;margin:5px 0}
        .divider::before,.divider::after{content:'';flex:1;height:1px;background:rgba(0,0,0,0.3)}
        .divider span{color:#2d3436}
        .error-msg{color:#d63031;background:rgba(255,255,255,0.9);padding:8px 15px;border-radius:10px;font-size:0.9em;margin-top:10px;display:none}
        
        #lobby-screen{text-align:center}
        .lobby-box{background:rgba(255,255,255,0.25);border-radius:20px;padding:25px;margin:20px 0}
        .lobby-code{font-size:2.5em;color:#2d3436;letter-spacing:10px;margin:10px 0}
        .diff-badge{display:inline-block;padding:8px 20px;border-radius:20px;font-weight:700;margin:10px 0;color:#fff}
        .diff-badge.einfach{background:#00b894}.diff-badge.mittel{background:#e17055}.diff-badge.schwer{background:#d63031}
        
        .teams-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:20px 0}
        @media(max-width:500px){.teams-grid{grid-template-columns:1fr}}
        .team-box{background:rgba(255,255,255,0.2);border-radius:15px;padding:15px;border:2px solid rgba(0,0,0,0.1)}
        .team-box h3{margin-bottom:10px;color:#2d3436}
        .team-box.mond{border-color:#9c88ff}.team-box.sonne{border-color:#f39c12}.team-box.stern{border-color:#e84393}.team-box.ozean{border-color:#00cec9}
        .team-players{min-height:40px;display:flex;flex-wrap:wrap;gap:5px}
        .team-player{padding:5px 10px;background:rgba(0,0,0,0.15);border-radius:10px;font-size:0.85em;color:#2d3436}
        
        .start-game-btn{font-size:1.2em;padding:15px 50px;border:none;border-radius:30px;background:#2d3436;color:#fff;font-weight:700;cursor:pointer;margin:15px 0}
        .start-game-btn:disabled{opacity:0.5;cursor:not-allowed}
        .small-btn{font-size:0.85em;padding:8px 15px;border:1px solid rgba(0,0,0,0.3);border-radius:15px;background:transparent;color:#2d3436;cursor:pointer;margin:5px}
        .small-btn.danger{border-color:#d63031;color:#d63031}
        
        .scoreboard{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px}
        @media(max-width:600px){.scoreboard{grid-template-columns:1fr 1fr}}
        .team-score{padding:12px;border-radius:12px;text-align:center;color:#2d3436}
        .team-score.mond{background:rgba(156,136,255,0.5);border:2px solid #9c88ff}
        .team-score.sonne{background:rgba(243,156,18,0.5);border:2px solid #f39c12}
        .team-score.stern{background:rgba(232,67,147,0.5);border:2px solid #e84393}
        .team-score.ozean{background:rgba(0,206,201,0.5);border:2px solid #00cec9}
        .team-score .emoji{font-size:1.5em}.team-score .points{font-size:1.3em;font-weight:700}
        
        .game-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:12px 15px;background:rgba(255,255,255,0.25);border-radius:15px;flex-wrap:wrap;gap:10px;color:#2d3436}
        .timer{font-size:2em;font-weight:700;color:#2d3436}.timer.warning{color:#e17055}.timer.danger{color:#d63031;animation:pulse 0.5s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        
        .quiz-section{background:rgba(255,255,255,0.2);border:2px solid rgba(0,0,0,0.1);border-radius:20px;padding:20px;margin-bottom:15px}
        .category-badge{display:inline-block;padding:5px 15px;background:rgba(0,0,0,0.15);border-radius:20px;font-size:0.85em;margin-bottom:12px;color:#2d3436}
        
        .word-pool{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:20px;min-height:50px}
        .word-chip{padding:10px 18px;background:#fff;border:2px solid #2d3436;border-radius:20px;font-size:1.1em;cursor:pointer;color:#2d3436;font-weight:600;transition:all 0.2s}
        .word-chip:hover{background:#2d3436;color:#fff;transform:scale(1.05)}
        .word-chip.used{opacity:0.3;cursor:not-allowed}
        
        .sentence-area{min-height:60px;padding:15px;background:rgba(255,255,255,0.6);border:3px dashed rgba(0,0,0,0.3);border-radius:15px;display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px}
        .sentence-area .word-chip{background:#2d3436;color:#fff;border-color:#2d3436}
        .sentence-area .word-chip:hover{background:#636e72}
        
        .action-btns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
        .action-btn{padding:12px 25px;border:none;border-radius:20px;font-size:1em;font-weight:700;cursor:pointer}
        .action-btn.submit{background:#00b894;color:#fff}
        .action-btn.submit:disabled{opacity:0.5;cursor:not-allowed}
        .action-btn.clear{background:#636e72;color:#fff}
        
        .answer-status{text-align:center;padding:12px;margin-top:15px;border-radius:10px;font-weight:700;display:none}
        .answer-status.show{display:block}
        .answer-status.correct{background:rgba(0,184,148,0.5);color:#00b894}
        .answer-status.wrong{background:rgba(214,48,49,0.5);color:#d63031}
        .correct-answer{margin-top:10px;padding:10px;background:rgba(255,255,255,0.5);border-radius:10px;color:#2d3436}
        
        #gameover-screen{text-align:center;padding:30px 20px}
        .result-icon{font-size:5em;margin-bottom:15px}
        .final-scores{background:rgba(255,255,255,0.25);border-radius:15px;padding:20px;margin-bottom:20px}
        .final-team{display:flex;justify-content:space-between;align-items:center;padding:12px;margin-bottom:8px;border-radius:10px;color:#2d3436;background:rgba(255,255,255,0.3)}
        .final-team.winner{background:rgba(255,215,0,0.5);border:2px solid #ffd700}
        
        .connection-status{position:fixed;top:10px;right:10px;padding:5px 10px;border-radius:12px;font-size:0.75em;background:rgba(0,0,0,0.4);color:#fff}
        .connection-status.connected{color:#55efc4}
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">Verbinde...</div>
    <div class="container">
        <h1>üîÄ Wortsalat-Battle</h1>
        
        <div id="login-screen" class="screen active">
            <div class="logo">üîÄ</div>
            <h2>Bringe die W√∂rter in Ordnung!<br><small style="opacity:0.7">Team-Wettbewerb</small></h2>
            <div class="difficulty-select">
                <button class="diff-btn einfach selected" data-diff="einfach">üü¢ Einfach</button>
                <button class="diff-btn mittel" data-diff="mittel">üü° Mittel</button>
                <button class="diff-btn schwer" data-diff="schwer">üî¥ Schwer</button>
            </div>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="Dein Name" maxlength="15">
                <select id="team-select">
                    <option value="">-- Team w√§hlen --</option>
                    <option value="mond">üåô Expedition Mond</option>
                    <option value="sonne">‚òÄÔ∏è Expedition Sonne</option>
                    <option value="stern">‚≠ê Expedition Stern</option>
                    <option value="ozean">üåä Expedition Ozean</option>
                </select>
                <input type="text" id="game-code" class="code-input" placeholder="CODE" maxlength="4">
            </div>
            <button class="btn-primary" id="join-btn">üö™ Beitreten</button>
            <div class="divider"><span>oder</span></div>
            <button class="btn-secondary" id="create-btn">üëë Neues Spiel erstellen</button>
            <div class="error-msg" id="error-msg"></div>
        </div>
        
        <div id="lobby-screen" class="screen">
            <div class="lobby-box">
                <h2 style="color:#2d3436">‚è≥ Warteraum</h2>
                <div class="lobby-code" id="lobby-code">CODE</div>
                <div class="diff-badge einfach" id="diff-badge">Einfach</div>
                <div class="teams-grid">
                    <div class="team-box mond"><h3>üåô Mond</h3><div class="team-players" id="team-mond"></div></div>
                    <div class="team-box sonne"><h3>‚òÄÔ∏è Sonne</h3><div class="team-players" id="team-sonne"></div></div>
                    <div class="team-box stern"><h3>‚≠ê Stern</h3><div class="team-players" id="team-stern"></div></div>
                    <div class="team-box ozean"><h3>üåä Ozean</h3><div class="team-players" id="team-ozean"></div></div>
                </div>
                <div id="host-controls">
                    <button class="start-game-btn" id="start-btn" disabled>‚ñ∂Ô∏è START</button>
                    <p style="color:#00b894;font-size:0.85em">üëë Du bist der Spielleiter</p>
                    <button class="small-btn danger" id="reset-btn">üîÑ Zur√ºcksetzen</button>
                </div>
                <div id="player-controls" style="display:none">
                    <p style="color:#e17055">‚è≥ Warte auf Spielleiter...</p>
                </div>
            </div>
        </div>
        
        <div id="game-screen" class="screen">
            <div class="scoreboard">
                <div class="team-score mond"><div class="emoji">üåô</div><div class="points" id="score-mond">0</div></div>
                <div class="team-score sonne"><div class="emoji">‚òÄÔ∏è</div><div class="points" id="score-sonne">0</div></div>
                <div class="team-score stern"><div class="emoji">‚≠ê</div><div class="points" id="score-stern">0</div></div>
                <div class="team-score ozean"><div class="emoji">üåä</div><div class="points" id="score-ozean">0</div></div>
            </div>
            <div class="game-header">
                <div id="question-num">1/15</div>
                <div class="timer" id="timer">20</div>
                <div id="my-team"></div>
            </div>
            <div class="quiz-section">
                <div class="category-badge" id="category"></div>
                <div class="word-pool" id="word-pool"></div>
                <div class="sentence-area" id="sentence-area"></div>
                <div class="action-btns">
                    <button class="action-btn clear" id="clear-btn">üóëÔ∏è L√∂schen</button>
                    <button class="action-btn submit" id="submit-btn" disabled>‚úÖ Pr√ºfen</button>
                </div>
                <div class="answer-status" id="answer-status"></div>
            </div>
        </div>
        
        <div id="gameover-screen" class="screen">
            <div class="result-icon" id="result-icon">üèÜ</div>
            <h2 id="result-title" style="color:#2d3436">Spiel beendet!</h2>
            <div class="final-scores" id="final-scores"></div>
            <button class="btn-primary" id="back-btn">üè† Zur√ºck</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
    var db, gameRef, playersRef, scoresRef;
    var gameCode, playerId, playerName, playerTeam, isHost, difficulty;
    var currentQ, answered, timerInt;
    var allPlayers, gameQuestions, teamScores;
    var selectedWords, currentWords;
    var teamEmoji = {mond:"üåô",sonne:"‚òÄÔ∏è",stern:"‚≠ê",ozean:"üåä"};
    
    var questions = {
        einfach: [
            {cat:"Dativ",w:["Ich","gebe","dir","das","Buch","."],s:"Ich gebe dir das Buch."},
            {cat:"Dativ",w:["Er","schenkt","mir","eine","Blume","."],s:"Er schenkt mir eine Blume."},
            {cat:"Dativ",w:["Sie","zeigt","uns","die","Fotos","."],s:"Sie zeigt uns die Fotos."},
            {cat:"Perfekt",w:["Ich","habe","einen","Film","gesehen","."],s:"Ich habe einen Film gesehen."},
            {cat:"Perfekt",w:["Sie","ist","nach","Berlin","gefahren","."],s:"Sie ist nach Berlin gefahren."},
            {cat:"Modalverben",w:["Du","musst","heute","lernen","."],s:"Du musst heute lernen."},
            {cat:"Modalverben",w:["Er","kann","gut","schwimmen","."],s:"Er kann gut schwimmen."},
            {cat:"Modalverben",w:["Wir","wollen","ins","Kino","gehen","."],s:"Wir wollen ins Kino gehen."},
            {cat:"Nebensatz",w:["Ich","hoffe",",","dass","du","kommst","."],s:"Ich hoffe, dass du kommst."},
            {cat:"wenn-Satz",w:["Wenn","es","regnet",",","bleibe","ich","zu","Hause","."],s:"Wenn es regnet, bleibe ich zu Hause."},
            {cat:"Pr√§sens",w:["Sie","arbeitet","jeden","Tag","."],s:"Sie arbeitet jeden Tag."},
            {cat:"Pr√§sens",w:["Wir","trinken","Kaffee","."],s:"Wir trinken Kaffee."},
            {cat:"Dativ",w:["Ich","helfe","meiner","Mutter","."],s:"Ich helfe meiner Mutter."},
            {cat:"Perfekt",w:["Er","hat","Kuchen","gebacken","."],s:"Er hat Kuchen gebacken."},
            {cat:"Modalverben",w:["Sie","darf","nicht","rauchen","."],s:"Sie darf nicht rauchen."}
        ],
        mittel: [
            {cat:"Konjunktiv II",w:["Ich","w√ºrde","gern","mehr","Urlaub","haben","."],s:"Ich w√ºrde gern mehr Urlaub haben."},
            {cat:"Konjunktiv II",w:["K√∂nnten","Sie","mir","bitte","helfen","?"],s:"K√∂nnten Sie mir bitte helfen?"},
            {cat:"Konjunktiv II",w:["Du","solltest","mehr","schlafen","."],s:"Du solltest mehr schlafen."},
            {cat:"Reflexiv",w:["Ich","wasche","mich","jeden","Morgen","."],s:"Ich wasche mich jeden Morgen."},
            {cat:"Reflexiv",w:["Du","musst","dich","beeilen","!"],s:"Du musst dich beeilen!"},
            {cat:"Konnektoren",w:["Ich","bleibe","zu","Hause",",","weil","ich","krank","bin","."],s:"Ich bleibe zu Hause, weil ich krank bin."},
            {cat:"Konnektoren",w:["Obwohl","er","m√ºde","ist",",","arbeitet","er","weiter","."],s:"Obwohl er m√ºde ist, arbeitet er weiter."},
            {cat:"Verben+Pr√§p.",w:["Ich","warte","auf","den","Bus","."],s:"Ich warte auf den Bus."},
            {cat:"Verben+Pr√§p.",w:["Er","denkt","oft","an","seine","Familie","."],s:"Er denkt oft an seine Familie."},
            {cat:"als/wenn",w:["Als","ich","ein","Kind","war",",","spielte","ich","viel","."],s:"Als ich ein Kind war, spielte ich viel."},
            {cat:"Dativ",w:["Der","Lehrer","erkl√§rt","den","Sch√ºlern","die","Grammatik","."],s:"Der Lehrer erkl√§rt den Sch√ºlern die Grammatik."},
            {cat:"Konjunktiv II",w:["Es","w√§re","sch√∂n",",","wenn","du","kommst","."],s:"Es w√§re sch√∂n, wenn du kommst."},
            {cat:"Reflexiv",w:["Sie","interessiert","sich","f√ºr","Kunst","."],s:"Sie interessiert sich f√ºr Kunst."},
            {cat:"Konnektoren",w:["Er","lernt",",","damit","er","die","Pr√ºfung","besteht","."],s:"Er lernt, damit er die Pr√ºfung besteht."},
            {cat:"Verben+Pr√§p.",w:["Sie","freut","sich","auf","den","Urlaub","."],s:"Sie freut sich auf den Urlaub."}
        ],
        schwer: [
            {cat:"Konj. II Verg.",w:["Ich","w√§re","gern","fr√ºher","gekommen","."],s:"Ich w√§re gern fr√ºher gekommen."},
            {cat:"Konj. II Verg.",w:["Das","h√§tte","ich","nicht","gedacht","."],s:"Das h√§tte ich nicht gedacht."},
            {cat:"Passiv",w:["Das","Haus","wird","gerade","gebaut","."],s:"Das Haus wird gerade gebaut."},
            {cat:"Passiv",w:["Der","Brief","ist","geschrieben","worden","."],s:"Der Brief ist geschrieben worden."},
            {cat:"Relativsatz",w:["Der","Mann",",","der","dort","steht",",","ist","mein","Chef","."],s:"Der Mann, der dort steht, ist mein Chef."},
            {cat:"Genitiv",w:["Das","ist","das","Auto","meines","Chefs","."],s:"Das ist das Auto meines Chefs."},
            {cat:"je...desto",w:["Je","mehr","ich","lerne",",","desto","besser","verstehe","ich","."],s:"Je mehr ich lerne, desto besser verstehe ich."},
            {cat:"Infinitiv+zu",w:["Ich","habe","keine","Zeit",",","das","zu","erledigen","."],s:"Ich habe keine Zeit, das zu erledigen."},
            {cat:"indirekte Rede",w:["Er","sagte",",","er","sei","m√ºde","."],s:"Er sagte, er sei m√ºde."},
            {cat:"Plusquamperf.",w:["Nachdem","ich","gegessen","hatte",",","ging","ich","spazieren","."],s:"Nachdem ich gegessen hatte, ging ich spazieren."},
            {cat:"Konj. II Verg.",w:["Wenn","ich","das","gewusst","h√§tte",",","w√§re","ich","gekommen","."],s:"Wenn ich das gewusst h√§tte, w√§re ich gekommen."},
            {cat:"Relativsatz",w:["Die","Frau",",","der","ich","helfe",",","ist","nett","."],s:"Die Frau, der ich helfe, ist nett."},
            {cat:"Genitiv",w:["Die","Farbe","des","Hauses","ist","blau","."],s:"Die Farbe des Hauses ist blau."},
            {cat:"Passiv",w:["Das","Problem","muss","gel√∂st","werden","."],s:"Das Problem muss gel√∂st werden."},
            {cat:"H√∂flichkeit",w:["W√ºrden","Sie","mir","bitte","helfen","?"],s:"W√ºrden Sie mir bitte helfen?"}
        ]
    };
    
    function init() {
        isHost = false;
        difficulty = 'einfach';
        currentQ = -1;
        answered = false;
        timerInt = null;
        allPlayers = [];
        gameQuestions = [];
        teamScores = {mond:0,sonne:0,stern:0,ozean:0};
        selectedWords = [];
        currentWords = [];
        
        firebase.initializeApp({
            apiKey: "AIzaSyBDChXlm34Kr7Gg0Dw458GiiwoLnWJAnxM",
            authDomain: "lern-deutsch-arash.firebaseapp.com",
            databaseURL: "https://lern-deutsch-arash-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lern-deutsch-arash"
        });
        db = firebase.database();
        
        db.ref(".info/connected").on("value", function(s) {
            var el = document.getElementById("connection-status");
            if (s.val()) {
                el.textContent = "üü¢ Online";
                el.className = "connection-status connected";
            } else {
                el.textContent = "üî¥ Offline";
                el.className = "connection-status";
            }
        });
        
        setupButtons();
    }
    
    function setupButtons() {
        var diffBtns = document.querySelectorAll('.diff-btn');
        for (var i = 0; i < diffBtns.length; i++) {
            diffBtns[i].onclick = function() {
                for (var j = 0; j < diffBtns.length; j++) { diffBtns[j].classList.remove('selected'); }
                this.classList.add('selected');
                difficulty = this.getAttribute('data-diff');
            };
        }
        
        document.getElementById("create-btn").onclick = createGame;
        document.getElementById("join-btn").onclick = joinGame;
        document.getElementById("start-btn").onclick = startGame;
        document.getElementById("reset-btn").onclick = resetGame;
        document.getElementById("back-btn").onclick = backToHome;
        document.getElementById("clear-btn").onclick = clearSentence;
        document.getElementById("submit-btn").onclick = submitAnswer;
    }
    
    function genCode() {
        var chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        var code = "";
        for (var i = 0; i < 4; i++) { code += chars.charAt(Math.floor(Math.random() * chars.length)); }
        return code;
    }
    
    function showError(msg) {
        var el = document.getElementById("error-msg");
        el.textContent = msg;
        el.style.display = "block";
        setTimeout(function() { el.style.display = "none"; }, 3000);
    }
    
    function showScreen(id) {
        var screens = document.querySelectorAll('.screen');
        for (var i = 0; i < screens.length; i++) { screens[i].classList.remove('active'); }
        document.getElementById(id).classList.add('active');
    }
    
    function shuffle(arr) {
        var newArr = arr.slice();
        for (var i = newArr.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = newArr[i]; newArr[i] = newArr[j]; newArr[j] = temp;
        }
        return newArr;
    }
    
    function createGame() {
        playerName = document.getElementById("player-name").value.trim();
        playerTeam = document.getElementById("team-select").value;
        if (!playerName) { showError("Name eingeben!"); return; }
        if (!playerTeam) { showError("Team w√§hlen!"); return; }
        
        gameCode = genCode();
        playerId = "host_" + Date.now();
        isHost = true;
        gameQuestions = shuffle(questions[difficulty]).slice(0, 15);
        
        gameRef = db.ref("wortsalat2/" + gameCode);
        playersRef = db.ref("wortsalat2/" + gameCode + "/players");
        scoresRef = db.ref("wortsalat2/" + gameCode + "/scores");
        
        gameRef.remove().then(function() {
            return gameRef.set({ status: "lobby", difficulty: difficulty, currentQuestion: -1, questionStart: null, questions: gameQuestions, host: playerId });
        }).then(function() { return scoresRef.set({mond:0,sonne:0,stern:0,ozean:0}); })
        .then(function() {
            return playersRef.child(playerId).set({ name: playerName, team: playerTeam, isHost: true, answered: false });
        }).then(function() {
            playersRef.child(playerId).onDisconnect().remove();
            showLobby();
            setupListeners();
        });
    }
    
    function joinGame() {
        playerName = document.getElementById("player-name").value.trim();
        playerTeam = document.getElementById("team-select").value;
        gameCode = document.getElementById("game-code").value.trim().toUpperCase();
        
        if (!playerName) { showError("Name eingeben!"); return; }
        if (!playerTeam) { showError("Team w√§hlen!"); return; }
        if (!gameCode || gameCode.length !== 4) { showError("4-stelliger Code!"); return; }
        
        playerId = "p_" + Date.now() + "_" + Math.random().toString(36).substr(2, 4);
        isHost = false;
        
        gameRef = db.ref("wortsalat2/" + gameCode);
        playersRef = db.ref("wortsalat2/" + gameCode + "/players");
        scoresRef = db.ref("wortsalat2/" + gameCode + "/scores");
        
        gameRef.once("value").then(function(s) {
            if (!s.exists()) { showError("Spiel nicht gefunden!"); return Promise.reject("not found"); }
            if (s.val().status !== "lobby") { showError("Spiel l√§uft bereits!"); return Promise.reject("running"); }
            difficulty = s.val().difficulty;
            gameQuestions = s.val().questions;
            return playersRef.child(playerId).set({ name: playerName, team: playerTeam, isHost: false, answered: false });
        }).then(function() {
            playersRef.child(playerId).onDisconnect().remove();
            showLobby();
            setupListeners();
        }).catch(function(e) { console.log(e); });
    }
    
    function showLobby() {
        showScreen("lobby-screen");
        document.getElementById("lobby-code").textContent = gameCode;
        var badge = document.getElementById("diff-badge");
        badge.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
        badge.className = "diff-badge " + difficulty;
        document.getElementById("host-controls").style.display = isHost ? "block" : "none";
        document.getElementById("player-controls").style.display = isHost ? "none" : "block";
    }
    
    function setupListeners() {
        playersRef.on("value", function(snap) {
            var players = [];
            snap.forEach(function(c) { var d = c.val(); if (d && d.name) { d.id = c.key; players.push(d); } });
            allPlayers = players;
            updatePlayers();
        });
        scoresRef.on("value", function(snap) { var s = snap.val(); if (s) { teamScores = s; updateScores(); } });
        gameRef.on("value", function(snap) {
            var game = snap.val();
            if (!game) { backToHome(); return; }
            if (game.status === "playing") {
                showScreen("game-screen");
                if (game.currentQuestion !== currentQ) { currentQ = game.currentQuestion; answered = false; hideStatus(); showQuestion(game.questionStart); }
            } else if (game.status === "finished") { endGame(); }
        });
    }
    
    function updatePlayers() {
        var teams = ["mond","sonne","stern","ozean"];
        for (var t = 0; t < teams.length; t++) {
            var team = teams[t];
            var teamPlayers = [];
            for (var i = 0; i < allPlayers.length; i++) { if (allPlayers[i].team === team) teamPlayers.push(allPlayers[i]); }
            var html = "";
            if (teamPlayers.length > 0) { for (var i = 0; i < teamPlayers.length; i++) { var p = teamPlayers[i]; html += '<div class="team-player">' + p.name + (p.isHost ? ' üëë' : '') + '</div>'; } }
            else { html = '<span style="color:#999;font-size:0.8em">Leer</span>'; }
            document.getElementById("team-" + team).innerHTML = html;
        }
        var nonHostCount = 0;
        for (var i = 0; i < allPlayers.length; i++) { if (!allPlayers[i].isHost) nonHostCount++; }
        document.getElementById("start-btn").disabled = nonHostCount === 0;
    }
    
    function updateScores() {
        var teams = ["mond","sonne","stern","ozean"];
        for (var i = 0; i < teams.length; i++) { document.getElementById("score-" + teams[i]).textContent = teamScores[teams[i]] || 0; }
    }
    
    function hideStatus() { var st = document.getElementById("answer-status"); st.className = "answer-status"; st.innerHTML = ""; }
    
    function startGame() {
        if (!isHost) return;
        playersRef.once("value", function(s) {
            s.forEach(function(c) { playersRef.child(c.key).update({ answered: false }); });
            scoresRef.set({mond:0,sonne:0,stern:0,ozean:0});
            gameRef.update({ status: "playing", currentQuestion: 0, questionStart: Date.now() });
        });
    }
    
    function resetGame() {
        if (!confirm("Zur√ºcksetzen?")) return;
        gameRef.update({ status: "lobby", currentQuestion: -1, questionStart: null });
        scoresRef.set({mond:0,sonne:0,stern:0,ozean:0});
        currentQ = -1; hideStatus(); showScreen("lobby-screen");
    }
    
    function showQuestion(startTime) {
        if (currentQ >= gameQuestions.length) { gameRef.update({ status: "finished" }); return; }
        var q = gameQuestions[currentQ];
        document.getElementById("question-num").textContent = (currentQ + 1) + "/" + gameQuestions.length;
        document.getElementById("category").textContent = q.cat;
        document.getElementById("my-team").textContent = teamEmoji[playerTeam];
        selectedWords = [];
        currentWords = shuffle(q.w.slice());
        renderWordPool(); renderSentenceArea();
        document.getElementById("submit-btn").disabled = true;
        startTimer(startTime);
    }
    
    function renderWordPool() {
        var pool = document.getElementById("word-pool");
        pool.innerHTML = "";
        for (var i = 0; i < currentWords.length; i++) {
            var word = currentWords[i];
            var used = selectedWords.indexOf(i) !== -1;
            var chip = document.createElement("div");
            chip.className = "word-chip" + (used ? " used" : "");
            chip.textContent = word;
            chip.setAttribute("data-idx", i);
            if (!used && !answered) { chip.onclick = (function(idx) { return function() { addWord(idx); }; })(i); }
            pool.appendChild(chip);
        }
    }
    
    function renderSentenceArea() {
        var area = document.getElementById("sentence-area");
        area.innerHTML = "";
        for (var i = 0; i < selectedWords.length; i++) {
            var idx = selectedWords[i];
            var chip = document.createElement("div");
            chip.className = "word-chip";
            chip.textContent = currentWords[idx];
            if (!answered) { chip.onclick = (function(pos) { return function() { removeWord(pos); }; })(i); }
            area.appendChild(chip);
        }
        document.getElementById("submit-btn").disabled = selectedWords.length !== currentWords.length || answered;
    }
    
    function addWord(idx) { if (answered) return; if (selectedWords.indexOf(idx) !== -1) return; selectedWords.push(idx); renderWordPool(); renderSentenceArea(); }
    function removeWord(pos) { if (answered) return; selectedWords.splice(pos, 1); renderWordPool(); renderSentenceArea(); }
    function clearSentence() { if (answered) return; selectedWords = []; renderWordPool(); renderSentenceArea(); }
    
    function submitAnswer() {
        if (answered || selectedWords.length !== currentWords.length) return;
        answered = true;
        var q = gameQuestions[currentQ];
        var userSentence = "";
        for (var i = 0; i < selectedWords.length; i++) { userSentence += currentWords[selectedWords[i]]; if (i < selectedWords.length - 1) userSentence += " "; }
        var correctNorm = q.s.replace(/\s+/g, " ").trim().replace(/\s+([.,!?])/g, "$1");
        var userNorm = userSentence.replace(/\s+/g, " ").trim().replace(/\s+([.,!?])/g, "$1");
        var isCorrect = userNorm === correctNorm;
        var st = document.getElementById("answer-status");
        if (isCorrect) { st.innerHTML = "‚úÖ Richtig! +1 f√ºr " + teamEmoji[playerTeam]; st.className = "answer-status correct show"; scoresRef.child(playerTeam).transaction(function(v) { return (v || 0) + 1; }); }
        else { st.innerHTML = "‚ùå Falsch!<div class='correct-answer'>Richtig: " + q.s + "</div>"; st.className = "answer-status wrong show"; }
        playersRef.child(playerId).update({ answered: true });
        document.getElementById("submit-btn").disabled = true;
    }
    
    function startTimer(startTime) {
        if (timerInt) clearInterval(timerInt);
        var el = document.getElementById("timer");
        function tick() {
            var elapsed = Math.floor((Date.now() - startTime) / 1000);
            var rem = Math.max(0, 20 - elapsed);
            el.textContent = rem;
            if (rem <= 5) { el.className = "timer danger"; } else if (rem <= 10) { el.className = "timer warning"; } else { el.className = "timer"; }
            if (rem === 0) {
                clearInterval(timerInt);
                if (!answered) {
                    answered = true;
                    var q = gameQuestions[currentQ];
                    var st = document.getElementById("answer-status");
                    st.innerHTML = "‚è∞ Zeit abgelaufen!<div class='correct-answer'>Richtig: " + q.s + "</div>";
                    st.className = "answer-status wrong show";
                    playersRef.child(playerId).update({ answered: true });
                    document.getElementById("submit-btn").disabled = true;
                }
                if (isHost) {
                    setTimeout(function() {
                        if (currentQ + 1 >= gameQuestions.length) { gameRef.update({ status: "finished" }); }
                        else { playersRef.once("value", function(s) { s.forEach(function(c) { playersRef.child(c.key).update({ answered: false }); }); gameRef.update({ currentQuestion: currentQ + 1, questionStart: Date.now() }); }); }
                    }, 3000);
                }
            }
        }
        tick(); timerInt = setInterval(tick, 100);
    }
    
    function endGame() {
        if (timerInt) clearInterval(timerInt);
        showScreen("gameover-screen");
        var sortedTeams = Object.keys(teamScores).sort(function(a, b) { return teamScores[b] - teamScores[a]; });
        var winner = sortedTeams[0];
        document.getElementById("result-icon").textContent = teamEmoji[winner];
        document.getElementById("result-title").textContent = teamEmoji[winner] + " gewinnt mit " + teamScores[winner] + " Punkten!";
        var html = "";
        for (var i = 0; i < sortedTeams.length; i++) {
            var t = sortedTeams[i]; var winClass = i === 0 ? ' winner' : '';
            html += '<div class="final-team' + winClass + '"><span>' + teamEmoji[t] + ' ' + t.charAt(0).toUpperCase() + t.slice(1) + '</span><span style="font-size:1.3em;font-weight:700">' + teamScores[t] + '</span></div>';
        }
        document.getElementById("final-scores").innerHTML = html;
    }
    
    function backToHome() {
        if (timerInt) clearInterval(timerInt);
        if (gameRef) gameRef.off();
        if (playersRef) { playersRef.off(); if (playerId) playersRef.child(playerId).remove(); }
        if (scoresRef) scoresRef.off();
        gameCode = null; playerId = null; isHost = false; currentQ = -1;
        teamScores = {mond:0,sonne:0,stern:0,ozean:0}; selectedWords = [];
        hideStatus(); showScreen("login-screen");
        document.getElementById("game-code").value = "";
        document.getElementById("team-select").value = "";
    }
    
    window.onload = init;
    </script>
    <script data-goatcounter="https://aguitoo.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
